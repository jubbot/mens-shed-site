---
export const prerender = false;

import Page from './[category]/[slug].astro'; // reuse the same component by delegating when no category
import { sanity } from '../../lib/sanityClient';

const { slug } = Astro.params;

const QUERY = `*[_type=="product" && slug.current==$slug][0]{
  "slug": slug.current,
  "category": storeCategory->{ "slug": slug.current }
}`;

const p = await sanity.fetch(QUERY, { slug });

if (!p) {
  return new Response('Not found', { status: 404 });
}

if (p?.category?.slug) {
  // canonicalize to /store/{category}/{slug}
  return Astro.redirect(`/store/${p.category.slug}/${p.slug}`);
}

// No category â†’ render the same UI by mounting the category route with a fake "category" param
// We simply pass through to the [category]/[slug] page using a dummy category segment.
Astro.params.category = 'uncategorised';
const { default: Component } = await import('./[category]/[slug].astro');
const result = await Component(Astro.props, Astro);
return result;
