---
interface Props {
  currentPath?: string;
  user?: any;
  displayName?: string | null;
  profile?: { first_name?: string | null; last_name?: string | null; display_name?: string | null } | null;
}

const { currentPath, user, displayName } = Astro.props as Props;
const path = currentPath ?? Astro.url.pathname;

const isActive = (href: string) =>
  path === href || (href !== '/' && path.startsWith(href)) ? 'active' : '';
---

<header class="primary" role="banner">
  <div class="width-fixed grid gap align-bottom">
    <div class="l-4 m-4 s-12">
      <a href="/" class="brand">
        <img
          src="/images/mensshed-logo-coloured.svg"
          alt="Menâ€™s Shed Townsville Logo"
          width="150"
          height="auto"
        />
      </a>
    </div>

    <div class="l-8 m-8 s-12">
      <div class="topbar grid align-center content-end">
        <span><a href="/job-form"><i class="wt-clipboard"></i> Start Job</a></span>
        <span><a href="/membership"><i class="wt-user1"></i> Become a member</a></span>

        <span id="auth-slot" data-ssr-user={displayName ? '1' : '0'}>
          {user && displayName ? (
            <details class="user-menu">
              <summary class="user-summary">
                <i class="wt-user1" aria-hidden="true"></i>
                <span class="hello">Hello {displayName}</span>
              </summary>
              <ul class="user-dropdown">
                <li>
                  <a href="/dashboard"><i class="wt-mountain" aria-hidden="true"></i> Dashboard</a>
                </li>
                <li>
                  <form action="/api/auth/logout" method="post">
                    <button type="submit"><i class="wt-logout" aria-hidden="true"></i> Logout</button>
                  </form>
                </li>
              </ul>
            </details>
          ) : (
            <a href="/dashboard"><i class="wt-mountain" aria-hidden="true"></i> Dashboard</a>
          )}
        </span>
      </div>

      <nav class="grid content-end main-nav" role="navigation" aria-label="Primary">
        <div class="has-dropmenu">
          <a
            href="/projects"
            class={isActive('/projects')}
            aria-current={isActive('/projects') ? 'page' : undefined}
          >
            Projects
          </a>
          <ul class="dropmenu" aria-label="Projects submenu">
            <li>
              <a href="/projects" class={isActive('/projects')}>
                <i class="wt-grid" aria-hidden="true"></i><span>All projects</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="has-dropmenu">
          <a
            href="/support"
            class={isActive('/support')}
            aria-current={isActive('/support') ? 'page' : undefined}
          >
            Support
          </a>
          <ul class="dropmenu" aria-label="Support submenu"><li></li></ul>
        </div>

        <div class="has-dropmenu">
          <a
            href="/store"
            class={isActive('/store')}
            aria-current={isActive('/store') ? 'page' : undefined}
          >
            Store
          </a>
          <ul class="dropmenu" aria-label="Store submenu">
            <li>
              <a href="/store" class={isActive('/store')}>
                <i class="wt-store" aria-hidden="true"></i><span>All products</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="has-dropmenu">
          <a
            href="/whats-on"
            class={isActive('/whats-on')}
            aria-current={isActive('/whats-on') ? 'page' : undefined}
          >
            What's on
          </a>
          <ul class="dropmenu" aria-label="What's on submenu">
            <li>
              <a href="/whats-on" class={isActive('/whats-on')}>
                <i class="wt-calendar2" aria-hidden="true"></i><span>All events</span>
              </a>
            </li>
          </ul>
        </div>

        <div>
          <a
            href="/contact"
            class={isActive('/contact')}
            aria-current={isActive('/contact') ? 'page' : undefined}
          >
            Contact
          </a>
        </div>
      </nav>
    </div>
  </div>
</header>

<style>
  .main-nav a.active {
    color: var(--brand, #2a7f62);
    font-weight: 700;
    text-decoration: none;
    position: relative;
  }
  .main-nav a.active::after {
    content: '';
    position: absolute;
    left: 0; right: 0; bottom: -0.35rem;
    height: 2px;
    background: currentColor;
    border-radius: 2px;
  }
  .user-menu { position: relative; }
  .user-summary { list-style: none; cursor: pointer; display: inline-flex; gap: .5rem; align-items: center; }
  .user-summary::-webkit-details-marker { display: none; }
  .user-dropdown {
    position: absolute; right: 0; margin: 0; padding: .5rem 0; list-style: none;
    background: #fff; border: 1px solid var(--border, #e5e7eb); border-radius: 10px;
    min-width: 180px; box-shadow: 0 8px 28px rgba(0,0,0,.08); z-index: 50;
  }
  .user-dropdown a, .user-dropdown button {
    display: block; width: 100%; text-align: left; padding: .5rem .9rem;
    background: transparent; border: 0; color: inherit; text-decoration: none; cursor: pointer;
  }
  .user-dropdown a:hover, .user-dropdown button:hover { background: #f7faf9; }
  .user-menu[open] > .user-summary { font-weight: 600; }
</style>
