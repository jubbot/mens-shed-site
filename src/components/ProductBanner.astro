---
import { getStoreStats } from '../lib/getStoreStats';

let { productsCount, soldCount, viewsCount, viewsCompact } = Astro.props;

if (productsCount == null || soldCount == null || (viewsCount == null && !viewsCompact)) {
  try {
    const s = await getStoreStats();
    productsCount ??= s.productsAvailable;
    soldCount     ??= s.sold;
    viewsCount    ??= s.productViews;
    viewsCompact  ??= s.viewsCompact;
  } catch {}
}

const fmtCompact = (n: number) =>
  new Intl.NumberFormat('en', { notation: 'compact', maximumFractionDigits: 1 }).format(n ?? 0);
const viewsText = viewsCompact ?? fmtCompact(viewsCount ?? 0);
---
<div class="grid banner">
  <div class="l-8 m-8 s-12">
    <div class="crumpbet"><span><a href="#">Store</a></span></div>
    <h1 class="l-txt">Men's Shed Townsville Store</h1>
    <div class="statistic grid">
      <div class="figure"><span class="num">{productsCount ?? 0}</span> <span class="label">Products</span></div>
      <div class="figure"><span class="num">{soldCount ?? 0}</span> <span class="label">Sold</span></div>
      <div class="figure"><span class="num">{viewsText}</span> <span class="label">Views</span></div>
    </div>
    <slot name="subtitle" />
  </div>

  <div class="l-4 m-4 s-4">
    <div class="tipbox">
      <h3>How to support us</h3>
      <p>Townsville men generously volunteer their time and expertise to support local community projects — and they’re seeking your support to continue making a difference.</p>
      <a href="/support" class="btn btn-delta">Learn how to support us</a>
    </div>
  </div>

  <aside class="product-banner__aside"><slot /></aside>
</div>
